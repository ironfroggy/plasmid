<!doctype html>

<ul id="items">
</ul>

<input type="text" id="entry"></input>
<button id=add>Add</button>
<button id=reload>Reload</button>
<button id=clear>Clear</button>

<style>
    .item-complete {
        text-decoration: line-through;
    }
</style>

<script type="text/javascript" src="base64.js"></script>
<script type="text/javascript" src="jsonsca.js"></script>
<script type="text/javascript" src="plasmid.js"></script>
<script type="text/javascript">
    const api = window.location.protocol + '//' + window.location.host + '/api/';
    const access = "test";
    const secret = "test";

    var $items = document.getElementById('items');
    var $entry = document.getElementById('entry');
    var $add = document.getElementById('add');
    var $reload = document.getElementById('reload');
    var $clear = document.getElementById('clear');
    var itemmap = {};
    var database = new plasmid.Database({
        name: 'todo',
        api: api,
        schema: {
            version: 1,
            stores: {
                todo: {
                    sync: true,
                    indexes: {
                        todo: {key: "todo", unique: false, multi: false}
                    }
                },
            },
        },
        autoSync: false,
        access: access,
        secret: secret
    });
    database.on('opensuccess', show);
    database.on('updated', show);

    function show() {
        database.stores.todo.walk('todo').on('each', function(item){
            if (itemmap[item.key]) {
                update_item(item);
            } else {
                add_item(item);
            }
        });
    }

    function update_item(item) {
        var $li;
        $li = itemmap[item.key];
        $li.setAttribute('class', 'item' + (item.value.complete?' item-complete' : ''));
        $li.item = item;
    }

    function add_item(item) {
        var $li;
        $li = document.createElement('li');
        $li.innerHTML = item.value.todo;
        $li.setAttribute('class', 'item' + (item.value.complete?' item-complete' : ''));
        if (item.value.complete) {
            $li.setAttribute('style', 'display:none;');
        }
        $li.item = item;
        $li.onclick = itemclick;
        $items.appendChild($li);

        itemmap[item.key] = $li;
    }

    function itemclick() {
        var item = this.item;
        item.value.complete = !item.value.complete;
        database.stores.todo.put(item.key, item.value).then(function(){
            show();
        });
    };

    $entry.onkeyup = function(event) {
        if (event.keyCode === 13) {
            $add.onclick();
        }
    };

    $add.onclick = function(){
        var value = $entry.value;
        $entry.value = "";
        database.stores.todo.put(
            Base64.encode(Math.random().toString()),
            {todo: value, complete: false}
        ).then(function(){
            show();
        });
    };

    $reload.onclick = function() {
        database.sync();
    };

    $clear.onclick = function() {
        for (var i=0; i<$items.children.length; i++) {
            if ($items.children[i].item.value.complete) {
                $items.children[i].setAttribute('style', 'display:none;');
            }
        }
    };

</script>
